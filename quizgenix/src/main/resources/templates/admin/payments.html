<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/base :: layout(~{::section}, 'Payments')}">

<head>

</head>

<body>

    <section>
        <div id="global-loader" class="loader-overlay">
            <div class="spinner"></div>
            <div class="loading-text">PROCESSING...</div>
        </div>

        <div id="customModal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-icon" id="modalIcon"></div>
                <h3 class="modal-title" id="modalTitle">Confirm</h3>
                <p class="modal-message" id="modalMessage">Message goes here.</p>
                <div class="modal-actions" id="modalActions"></div>
            </div>
        </div>

        <h1>Transaction History</h1>

        <div class="filter-bar">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="searchInput" placeholder="Search ID, User or Amount..."
                    onkeyup="resetAndFilter()">
            </div>
            <select class="filter-select" id="statusFilter" onchange="resetAndFilter()">
                <option value="">All Status</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Failed">Failed</option>
            </select>
            <select class="filter-select" id="planFilter" onchange="resetAndFilter()">
                <option value="">All Plans</option>
                <option value="Basic">Basic</option>
                <option value="Pro">Pro</option>
                <option value="Plus">Plus</option>
                <option value="Premium">Premium</option>
            </select>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr th:each="payment : ${payments}" class="payment-row"
                        th:with="displayName=${payment.planName == 'Monthly Plan' ? 'Pro' : (payment.planName == '6-Month Plan' ? 'Plus' : (payment.planName == 'Yearly Plan' ? 'Premium' : payment.planName))}"
                        th:data-id="${payment.paymentId != null ? #strings.toLowerCase(payment.paymentId) : ''}"
                        th:data-user="${payment.user != null ? #strings.toLowerCase(payment.user.firstName + ' ' + payment.user.lastName) : (payment.archivedUserName != null ? #strings.toLowerCase(payment.archivedUserName) : '')}"
                        th:data-plan="${displayName}" th:data-status="${payment.status}"
                        th:data-amount="${payment.amount}">

                        <td style="font-family: monospace; color: #8b5cf6;"
                            th:text="'#' + ${(payment.paymentId != null ? payment.paymentId : 'N/A')}"></td>
                        <td>
                            <div class="user-cell" th:if="${payment.user != null}">
                                <img th:src="@{${(payment.user.profileImage == null || payment.user.profileImage == 'profile.png') ? '/images/profile.png' : payment.user.profileImage}}"
                                    class="avatar-sm" style="object-fit: cover; border-radius: 50%;" alt="User">
                                <div class="user-info"><span
                                        th:text="${#strings.capitalizeWords(payment.user.firstName + ' ' + payment.user.lastName)}"></span><span
                                        class="user-email" th:text="${payment.user.email}"></span></div>
                            </div>
                            <div class="user-cell" th:unless="${payment.user != null}">
                                <div class="avatar-sm"
                                    style="background: #fee2e2; color: #ef4444; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="18" y1="8" x2="23" y2="13"></line>
                                        <line x1="23" y1="8" x2="18" y2="13"></line>
                                    </svg>
                                </div>
                                <div class="user-info">
                                    <span><span
                                            th:text="${payment.archivedUserName != null ? payment.archivedUserName : 'Unknown'}"></span><span
                                            class="deleted-badge">Deleted</span></span>
                                    <span class="user-email"
                                        th:text="${payment.archivedUserEmail != null ? payment.archivedUserEmail : 'No Email'}"></span>
                                </div>
                            </div>
                        </td>
                        <td th:text="${displayName}"></td>
                        <td style="font-weight: bold;" th:text="'â‚¹' + ${payment.amount}"></td>
                        <td
                            th:text="${payment.createdAt != null ? #temporals.format(payment.createdAt, 'MMM dd, yyyy') : 'N/A'}">
                        </td>
                        <td>
                            <span class="badge"
                                th:classappend="${payment.status == 'created' ? 'bg-pending' : (payment.status == 'captured' ? 'bg-paid' : (payment.status == 'failed' ? 'bg-failed' : 'bg-paid'))}"
                                th:text="${payment.status == 'captured' ? 'Paid' : (payment.status == 'created' ? 'Pending' : payment.status)}"></span>
                        </td>
                        <td>
                            <div class="action-icons">
                                <a th:href="@{'/admin/payments/invoice/' + ${payment.id}}" class="icon-btn"
                                    title="Download Invoice" target="_blank">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </a>
                                <button class="icon-btn" title="Send Invoice to User"
                                    th:onclick="'initiateSendInvoice(this, ' + ${payment.id} + ')'"
                                    th:disabled="${(payment.user == null and payment.archivedUserEmail == null) or (payment.user != null and payment.user.email == null)}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr id="noResultsRow" style="display: none;">
                        <td colspan="7" style="text-align: center; color: #94a3b8; padding: 2rem;">No transactions match
                            your filters.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-controls" id="paginationControls">
            <div id="showingText">Showing 0 to 0 of 0 entries</div>
            <div class="pagination-btns">
                <button class="page-btn" id="prevBtn" onclick="changePage(-1)" disabled>Previous</button>
                <span class="page-info" id="pageNumberDisplay">Page 1</span>
                <button class="page-btn" id="nextBtn" onclick="changePage(1)" disabled>Next</button>
            </div>
        </div>

        <script>
            // --- 1. GLOBAL VARIABLES ---
            const rowsPerPage = 10;
            let currentPage = 1;
            let allRows = [];       // All rows in DOM
            let filteredRows = [];  // Rows that match current filter

            // --- 2. INITIALIZATION ---
            window.addEventListener('load', function () {
                const loader = document.getElementById('global-loader');
                if (loader) { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); }

                // Initialize Table
                allRows = Array.from(document.querySelectorAll('.payment-row'));
                resetAndFilter(); // Initial Render
            });

            // --- 3. FILTERING LOGIC ---
            function resetAndFilter() {
                currentPage = 1; // Reset to page 1 on filter change
                applyFilter();
            }

            function applyFilter() {
                const input = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const planFilter = document.getElementById('planFilter').value;

                // 1. Filter the rows array
                filteredRows = allRows.filter(row => {
                    const txnId = row.getAttribute('data-id') || "";
                    const user = row.getAttribute('data-user') || "";
                    const amount = row.getAttribute('data-amount') || "";
                    const status = row.getAttribute('data-status') || "";
                    const plan = row.getAttribute('data-plan') || "";

                    const matchesKeyword = txnId.includes(input) || user.includes(input) || amount.includes(input);
                    const matchesStatus = (statusFilter === "") || (status === statusFilter);
                    const matchesPlan = (planFilter === "") || plan.includes(planFilter);

                    return matchesKeyword && matchesStatus && matchesPlan;
                });

                // 2. Update No Results Message
                const noResultsRow = document.getElementById('noResultsRow');
                if (filteredRows.length === 0) {
                    noResultsRow.style.display = "";
                    document.getElementById('paginationControls').style.display = 'none'; // Hide pagination if empty
                } else {
                    noResultsRow.style.display = "none";
                    document.getElementById('paginationControls').style.display = 'flex';
                }

                // 3. Render Current Page
                renderTable();
            }

            // --- 4. PAGINATION LOGIC ---
            function renderTable() {
                // Hide ALL rows first
                allRows.forEach(row => row.style.display = 'none');

                // Calculate pagination indices
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;

                // Show only filtered rows for current page
                const rowsToShow = filteredRows.slice(startIndex, endIndex);
                rowsToShow.forEach(row => row.style.display = '');

                // Update Controls
                updatePaginationControls(totalPages, startIndex, endIndex, filteredRows.length);
            }

            function updatePaginationControls(totalPages, start, end, total) {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const pageDisplay = document.getElementById('pageNumberDisplay');
                const showingText = document.getElementById('showingText');

                // Update Buttons
                prevBtn.disabled = (currentPage === 1);
                nextBtn.disabled = (currentPage >= totalPages || totalPages === 0);

                // Update Text
                pageDisplay.innerText = `Page ${currentPage} of ${totalPages || 1}`;

                // Update "Showing X to Y" text
                const actualEnd = Math.min(end, total);
                const actualStart = total === 0 ? 0 : start + 1;
                showingText.innerText = `Showing ${actualStart} to ${actualEnd} of ${total} entries`;
            }

            function changePage(direction) {
                const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
                const newPage = currentPage + direction;

                if (newPage > 0 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderTable();
                }
            }

            // --- 5. MODAL LOGIC (Kept same) ---
            const modal = document.getElementById('customModal');
            function showModal(title, message, isConfirm, onConfirm) {
                if (!modal) { alert(message); return; }
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalMessage').innerText = message;
                const actionsDiv = document.getElementById('modalActions');
                const iconDiv = document.getElementById('modalIcon');
                actionsDiv.innerHTML = '';
                if (isConfirm) {
                    iconDiv.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
                    const btnCancel = document.createElement('button'); btnCancel.className = 'modal-btn btn-cancel'; btnCancel.innerText = 'Cancel'; btnCancel.onclick = closeModal;
                    const btnConfirm = document.createElement('button'); btnConfirm.className = 'modal-btn btn-confirm'; btnConfirm.innerText = 'Send Invoice'; btnConfirm.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
                    actionsDiv.appendChild(btnCancel); actionsDiv.appendChild(btnConfirm);
                } else {
                    iconDiv.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                    const btnOk = document.createElement('button'); btnOk.className = 'modal-btn btn-close-only'; btnOk.innerText = 'Okay'; btnOk.onclick = closeModal;
                    actionsDiv.appendChild(btnOk);
                }
                modal.classList.add('show');
            }
            function closeModal() { if (modal) modal.classList.remove('show'); }

            function initiateSendInvoice(btn, paymentId) {
                showModal("Send Invoice?", "Email official invoice to user?", true, function () {
                    executeSendInvoice(btn, paymentId);
                });
            }

            function executeSendInvoice(btn, paymentId) {
                const csrfTokenMeta = document.querySelector("meta[name='_csrf']");
                const csrfHeaderMeta = document.querySelector("meta[name='_csrf_header']");

                if (!csrfTokenMeta || !csrfHeaderMeta) {
                    alert("Security Token Error: Check base.html");
                    return;
                }

                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span class="btn-spinner"></span>';
                btn.disabled = true;

                const headers = { 'Content-Type': 'application/json' };
                headers[csrfHeaderMeta.getAttribute("content")] = csrfTokenMeta.getAttribute("content");

                fetch('/admin/payments/invoice/send/' + paymentId, { method: 'POST', headers: headers })
                    .then(response => {
                        if (response.ok) return response.text().then(text => { showModal("Success", text, false); });
                        else return response.text().then(text => { throw new Error(text || "Server Error"); });
                    })
                    .catch(error => { showModal("Error", error.message, false); })
                    .finally(() => { btn.innerHTML = originalContent; btn.disabled = false; });
            }
        </script>
    </section>
</body>

</html>