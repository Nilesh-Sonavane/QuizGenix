<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/base :: layout(~{::section}, 'Analytics')}">

<head></head>

<body>

    <section>
        <h1>Admin Analytics</h1>
        <p class="welcome-text">Real-time platform insights and performance metrics.</p>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 th:text="${totalUsers}">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card">
                <h3 th:text="'₹' + ${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')}">₹0</h3>
                <p>Total Revenue</p>
            </div>
            <div class="stat-card">
                <h3 th:text="${aiQuizzesGenerated}">0</h3>
                <p>AI Quizzes Generated</p>
            </div>
            <div class="stat-card">
                <h3 th:text="${serverUptime}">0%</h3>
                <p>Server Uptime</p>
            </div>
        </div>

        <div class="charts-container">

            <div class="chart-card">
                <div class="chart-header">
                    <h3>User Growth</h3>
                    <select id="growthSelect" class="chart-select" onchange="updateGrowthChart()">
                        <option value="last6months">Last 6 Months</option>
                        <option value="lastyear" selected>Last Year</option>
                        <option value="alltime">All Time</option>
                    </select>
                </div>
                <div class="chart-box">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue Source</h3>
                    <select id="revenueSelect" class="chart-select" onchange="updateRevenueChart()">
                        <option value="monthly">This Month</option>
                        <option value="6months">Last 6 Months</option>
                        <option value="yearly" selected>Yearly</option>
                    </select>
                </div>
                <div class="chart-box">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <script>
            // Global variables to hold chart instances (so we can destroy/redraw them)
            let growthChartInstance = null;
            let revenueChartInstance = null;

            document.addEventListener('DOMContentLoaded', function () {
                // Load default charts on page load
                updateGrowthChart();
                updateRevenueChart();
            });

            // --- FUNCTION 1: FETCH & UPDATE USER GROWTH CHART ---
            function updateGrowthChart() {
                const range = document.getElementById('growthSelect').value;

                // Call the Spring Boot REST Controller
                fetch(`/admin/api/dashboard/growth-chart?range=${range}`)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('growthChart').getContext('2d');

                        // Destroy old chart if it exists to avoid visual glitches
                        if (growthChartInstance) {
                            growthChartInstance.destroy();
                        }

                        // Create New Chart
                        growthChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.labels, // Data from Backend
                                datasets: [{
                                    label: 'New Users',
                                    data: data.data, // Data from Backend
                                    borderColor: '#8b5cf6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointBackgroundColor: '#0B0E14',
                                    pointBorderColor: '#8b5cf6',
                                    pointBorderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                                }
                            }
                        });
                    })
                    .catch(error => console.error("Error loading growth chart:", error));
            }

            // --- FUNCTION 2: FETCH & UPDATE REVENUE CHART ---
            function updateRevenueChart() {
                const range = document.getElementById('revenueSelect').value;

                fetch(`/admin/api/dashboard/revenue-chart?range=${range}`)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('revenueChart').getContext('2d');

                        if (revenueChartInstance) {
                            revenueChartInstance.destroy();
                        }

                        revenueChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels, // Data from Backend (Plan Names)
                                datasets: [{
                                    data: data.data, // Data from Backend (Counts)
                                    backgroundColor: [
                                        '#3b82f6', // Blue
                                        '#a855f7', // Purple
                                        '#22c55e', // Green
                                        '#fbbf24', // Yellow
                                        '#ef4444'  // Red
                                    ],
                                    borderWidth: 0,
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '75%',
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: '#cbd5e1',
                                            padding: 20,
                                            usePointStyle: true
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error("Error loading revenue chart:", error));
            }
        </script>
    </section>

</body>

</html>