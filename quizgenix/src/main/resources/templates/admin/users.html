<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/base :: layout(~{::section}, 'Users')}">

<head>

</head>

<body>

    <section>
        <div id="global-loader" class="loader-overlay">
            <div class="spinner"></div>
            <div class="loading-text">PROCESSING...</div>
        </div>

        <h1>User Management</h1>

        <div class="filter-bar">
            <div class="search-box" style="display: flex; align-items: center; width: 100%;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="searchInput" placeholder="Search by name, email, or date..."
                    onkeyup="filterUsers()">
            </div>

            <select class="filter-select" id="statusFilter" onchange="filterUsers()">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Banned">Banned</option>
            </select>

            <select class="filter-select" id="planFilter" onchange="filterUsers()">
                <option value="">All Plans</option>
                <option value="Free">Basic (Free)</option>
                <option value="Monthly Plan">Pro (Monthly)</option>
                <option value="6-Month Plan">Plus (6-Month)</option>
                <option value="Yearly Plan">Premium (Yearly)</option>
            </select>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User Details</th>
                        <th>Role</th>
                        <th>Joined Date</th>
                        <th>Plan</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                    <tr th:each="user : ${users}" class="user-row"
                        th:data-name="${#strings.toLowerCase(user.firstName + ' ' + user.lastName)}"
                        th:data-email="${#strings.toLowerCase(user.email)}" th:data-plan="${user.activePlan}"
                        th:data-status="${user.enabled ? 'Active' : 'Banned'}">

                        <td>
                            <div class="user-cell">
                                <img th:src="@{${(user.profileImage == null || user.profileImage == 'profile.png') 
                                                ? '/images/profile.png' 
                                                : '/user-photos/' + user.profileImage}}" class="avatar-sm"
                                    style="object-fit: cover; border-radius: 50%;" alt="User">

                                <div class="user-info">
                                    <span
                                        th:text="${#strings.capitalizeWords(#strings.toLowerCase(user.firstName + ' ' + user.lastName))}">John
                                        Doe</span>
                                    <span class="user-email" th:text="${user.email}">john@example.com</span>
                                </div>
                            </div>
                        </td>

                        <td th:text="${user.role != null ? user.role : 'User'}">User</td>
                        <td th:text="${#temporals.format(user.createdAt, 'MMM dd, yyyy')}">Dec 10, 2024</td>

                        <td>
                            <span class="badge"
                                th:classappend="${user.activePlan == 'Monthly Plan' ? 'bg-pro' : (user.activePlan == 'Yearly Plan' ? 'bg-pro' : (user.activePlan == '6-Month Plan' ? 'bg-pro' : ''))}"
                                th:text="${user.activePlan == 'Free' ? 'Basic' : 
                                         (user.activePlan == 'Monthly Plan' ? 'Pro' : 
                                         (user.activePlan == '6-Month Plan' ? 'Plus' : 
                                         (user.activePlan == 'Yearly Plan' ? 'Premium' : user.activePlan)))}">
                                Free
                            </span>
                        </td>

                        <td>
                            <span th:if="${user.enabled}" class="badge bg-active">Active</span>
                            <span th:unless="${user.enabled}" class="badge bg-banned">Banned</span>
                        </td>

                        <td>
                            <div class="action-icons">
                                <button type="button" class="icon-btn" th:classappend="${!user.enabled} ? 'block' : ''"
                                    th:title="${user.enabled} ? 'Block User' : 'Unblock User'"
                                    th:onclick="'showModal(' + ${user.id} + ', \'' + ${user.enabled} + '\')'">

                                    <svg th:if="${user.enabled}" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    <svg th:unless="${user.enabled}" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                        <path d="M21 3v5h-5"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(users)}">
                        <td colspan="6" style="text-align: center; color: #94a3b8; padding: 2rem;">No users found in
                            database.</td>
                    </tr>

                    <tr id="noResultsRow" style="display: none;">
                        <td colspan="6" style="text-align: center; color: #94a3b8; padding: 2rem;">No users match your
                            filters.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="confirmModal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                        </path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <h3 class="modal-title">Change User Status?</h3>
                <p class="modal-text" id="modalMessage">Are you sure you want to perform this action?</p>

                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <a id="confirmLink" href="#" class="btn-confirm" onclick="showLoader()">Yes, Change it</a>
                </div>
            </div>
        </div>

        <script>
            // --- 0. LOADER LOGIC (UPDATED ID) ---

            // Hide loader on page load
            window.addEventListener('load', function () {
                const loader = document.getElementById('global-loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            });

            // Show loader manually (when action is confirmed)
            function showLoader() {
                const loader = document.getElementById('global-loader');
                loader.style.display = 'flex'; // Use flex to center content
                setTimeout(() => {
                    loader.style.opacity = '1';
                }, 10);
            }

            // --- 1. FILTER FUNCTION ---
            function filterUsers() {
                const input = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const planFilter = document.getElementById('planFilter').value;
                const rows = document.querySelectorAll('.user-row');
                let visibleCount = 0;

                rows.forEach(row => {
                    const rowStatus = row.getAttribute('data-status');
                    const rowPlan = row.getAttribute('data-plan');
                    const allRowText = row.innerText.toLowerCase();

                    const matchesKeyword = allRowText.includes(input);
                    const matchesStatus = (statusFilter === "") || (rowStatus === statusFilter);
                    const matchesPlan = (planFilter === "") || (rowPlan === planFilter);

                    if (matchesKeyword && matchesStatus && matchesPlan) {
                        row.style.display = "";
                        visibleCount++;
                    } else {
                        row.style.display = "none";
                    }
                });

                const noResultsRow = document.getElementById('noResultsRow');
                noResultsRow.style.display = (visibleCount === 0 && rows.length > 0) ? "" : "none";
            }

            // --- 2. MODAL FUNCTIONS ---
            function showModal(userId, isEnabled) {
                const modal = document.getElementById('confirmModal');
                const message = document.getElementById('modalMessage');
                const confirmLink = document.getElementById('confirmLink');

                if (isEnabled === 'true' || isEnabled === true) {
                    message.innerText = "This user is currently Active. Do you want to Block them?";
                    confirmLink.innerText = "Yes, Block User";
                    confirmLink.style.background = "#ef4444";
                } else {
                    message.innerText = "This user is currently Banned. Do you want to Activate them?";
                    confirmLink.innerText = "Yes, Activate User";
                    confirmLink.style.background = "#22c55e";
                }

                confirmLink.href = "/admin/users/toggle-status/" + userId;

                modal.style.display = "flex";
                setTimeout(() => {
                    document.querySelector('.modal-box').classList.add('active');
                }, 10);
            }

            function closeModal() {
                const modal = document.getElementById('confirmModal');
                document.querySelector('.modal-box').classList.remove('active');
                setTimeout(() => {
                    modal.style.display = "none";
                }, 200);
            }

            window.onclick = function (event) {
                const modal = document.getElementById('confirmModal');
                if (event.target == modal) {
                    closeModal();
                }
            }
        </script>

    </section>

</body>

</html>